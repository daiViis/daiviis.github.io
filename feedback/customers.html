<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Customer Management</title>
    
    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Oxygen:wght@300;400;700&family=Oxygen+Mono:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'sans': ['Oxygen', 'system-ui', '-apple-system', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <!-- Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- Database Configuration -->
    <script src="database-config.js"></script>

    <!-- Admin Styles -->
    <link rel="stylesheet" href="css/admin-styles.css">
    
    <!-- Shared Navbar -->
    <script src="js/shared-navbar.js"></script>
    
    <!-- Shared Admin Authentication -->
    <script src="js/admin-auth.js"></script>
</head>

<body class="bg-white min-h-screen">
    <!-- Main Dashboard -->
    <div id="dashboardContainer" class="max-w-6xl mx-auto px-4 py-6">
        <!-- Navbar will be injected here by shared-navbar.js -->

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-6 gap-3 mb-6">
            <div class="border border-black p-4 stats-card bg-white">
                <div class="text-2xl font-light text-black" id="totalCustomers">--</div>
                <div class="text-xs uppercase tracking-wide text-gray-500">Total Customers</div>
            </div>
            <div class="border border-black p-4 stats-card bg-white">
                <div class="text-2xl font-light text-black" id="activeProjects">--</div>
                <div class="text-xs uppercase tracking-wide text-gray-500">Active Projects</div>
            </div>
            <div class="border border-black p-4 stats-card bg-white">
                <div class="text-2xl font-light text-black" id="pendingFeedback">--</div>
                <div class="text-xs uppercase tracking-wide text-gray-500">Pending</div>
            </div>
            <div class="border border-black p-4 stats-card bg-white">
                <div class="text-2xl font-light text-black" id="totalValue">--</div>
                <div class="text-xs uppercase tracking-wide text-gray-500">Total Value</div>
            </div>
            <div class="border border-black p-4 stats-card bg-white">
                <div class="text-2xl font-light text-black" id="selectedCountStat">--</div>
                <div class="text-xs uppercase tracking-wide text-gray-500">Selected</div>
            </div>
            <div class="border border-black p-4 stats-card bg-white">
                <div class="text-2xl font-light text-black" id="thisMonthCustomers">--</div>
                <div class="text-xs uppercase tracking-wide text-gray-500">This Month</div>
            </div>
        </div>

        <!-- Filters and Actions -->
        <div class="border-2 border-gray-300 p-4 mb-6 active-section">
            <div class="flex flex-col sm:flex-row justify-between gap-4 mb-4">
                <div class="flex flex-wrap gap-2 sm:gap-4">
                    <select id="statusFilter" class="border-2 border-gray-400 px-3 py-2 bg-white focus:border-black focus:outline-none">
                        <option value="">All Status</option>
                        <option value="potential">Potential</option>
                        <option value="first-brief">First Brief</option>
                        <option value="contract-sent">Contract Sent</option>
                        <option value="contract-agreed">Contract Agreed</option>
                        <option value="in-progress">In Progress</option>
                        <option value="reviewing">Reviewing</option>
                        <option value="finished">Finished</option>
                    </select>
                    <select id="typeFilter" class="border-2 border-gray-400 px-3 py-2 bg-white focus:border-black focus:outline-none">
                        <option value="">All Types</option>
                        <option value="confirmed">Confirmed Clients</option>
                        <option value="potential">Potential Clients</option>
                    </select>
                    <input type="text" id="searchCustomer" placeholder="Search customers..." 
                           class="border-2 border-gray-400 px-3 py-2 bg-white focus:border-black focus:outline-none flex-1">
                </div>
                <button id="addNewCustomerBtn" class="bg-black text-white px-4 py-2 hover:bg-gray-800 transition-colors">
                    + Add New Client
                </button>
            </div>
        </div>

        <!-- Bulk Actions Bar -->
        <div id="bulkActionsBar" class="hidden border border-yellow-400 bg-yellow-50 p-3 mb-4">
            <div class="flex flex-col sm:flex-row sm:items-center justify-between gap-2">
                <div class="flex items-center space-x-2">
                    <span class="text-sm text-black"><span id="selectedCount">0</span> customers selected</span>
                </div>
                <div class="flex flex-wrap items-center gap-2">
                    <select id="bulkStatusChange" class="border border-gray-400 px-2 py-1 bg-white text-sm focus:outline-none focus:border-black">
                        <option value="">Change Status</option>
                        <option value="first-brief">First Brief</option>
                        <option value="contract-sent">Contract Sent</option>
                        <option value="contract-agreed">Contract Agreed</option>
                        <option value="in-progress">In Progress</option>
                        <option value="reviewing">Reviewing</option>
                        <option value="waiting-payment">Waiting for Payment</option>
                        <option value="finished">Finished</option>
                    </select>
                    <button id="applyBulkStatus" class="bg-blue-600 text-white px-3 py-1 text-sm hover:bg-blue-700">Apply</button>
                    <button id="bulkArchive" class="bg-gray-600 text-white px-3 py-1 text-sm hover:bg-gray-700">Archive</button>
                    <button id="clearSelection" class="border border-gray-400 text-black px-3 py-1 text-sm hover:bg-gray-100">Clear</button>
                </div>
            </div>
        </div>

        <!-- Customers Table -->
        <div class="border-2 border-black overflow-hidden">
            <div class="p-4 border-b-2 border-black section-header pl-6">
                <h2 class="text-lg font-light text-black">Customers</h2>
            </div>
            
            <div id="loadingState" class="p-8 text-center">
                <div class="text-black">Loading customers...</div>
            </div>

            <div id="errorState" class="p-8 text-center hidden">
                <div class="text-black mb-4">Failed to load customer data</div>
                <div class="text-gray-600 text-sm" id="errorMessage"></div>
                <button id="retryBtn" class="mt-4 bg-black text-white px-4 py-2 hover:bg-gray-800">Retry</button>
            </div>

            <div id="tableContainer" class="hidden overflow-x-auto">
                <table class="w-full min-w-[700px]">
                    <thead class="border-b border-black">
                        <tr>
                            <th class="px-4 py-3 text-left text-sm text-black w-12">
                                <input type="checkbox" id="selectAll" class="focus:outline-none" onchange="toggleSelectAll(this.checked)">
                            </th>
                            <th class="px-4 py-3 text-left text-sm text-black">Name</th>
                            <th class="px-4 py-3 text-left text-sm text-black">Company</th>
                            <th class="px-4 py-3 text-left text-sm text-black">Project</th>
                            <th class="px-4 py-3 text-left text-sm text-black">Price</th>
                            <th class="px-4 py-3 text-left text-sm text-black">Status</th>
                            <th class="px-4 py-3 text-left text-sm text-black">Created</th>
                        </tr>
                    </thead>
                    <tbody id="customersTableBody" class="divide-y divide-gray-200">
                    </tbody>
                </table>
            </div>

            <div id="emptyState" class="p-8 text-center hidden">
                <div class="text-gray-600">No customers found</div>
            </div>
        </div>
    </div>


    <!-- Customer Details Modal -->
    <div id="customerDetailsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white border-2 border-black max-w-4xl w-full mx-4 sm:mx-6 max-h-screen overflow-y-auto modal-content">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-lg font-light text-black">Customer Details</h3>
                    <div class="flex flex-wrap items-center gap-2">
                        <button id="saveCustomerChanges" class="bg-green-600 text-white px-3 py-1 text-sm hover:bg-green-700 hidden">Save Changes</button>
                        <button id="cancelCustomerChanges" class="border border-gray-400 text-black px-3 py-1 text-sm hover:bg-gray-100 hidden">Cancel</button>
                        <button id="closeDetailsModal" class="text-black hover:text-gray-600">×</button>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Customer Info -->
                    <div>
                        <div id="customerDetailsContent" class="space-y-4">
                            <!-- Customer details will be populated here -->
                        </div>
                    </div>
                    
                    <!-- Notes Section -->
                    <div class="border-l border-gray-300 pl-6">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-light text-black">Notes</h4>
                            <button id="addNoteBtn" class="bg-black text-white px-3 py-1 text-sm hover:bg-gray-800">Add Note</button>
                        </div>
                        
                        <!-- Add Note Form (Hidden by default) -->
                        <div id="addNoteForm" class="hidden mb-4 p-3 border border-gray-300 bg-gray-50">
                            <textarea id="noteText" placeholder="Enter your note..." 
                                    class="w-full px-3 py-2 border border-gray-400 bg-white focus:outline-none focus:border-black resize-none" 
                                    rows="3"></textarea>
                            <div class="flex flex-col sm:flex-row justify-end gap-2 mt-2">
                                <button id="cancelNoteBtn" class="px-3 py-1 text-sm text-black hover:bg-gray-100">Cancel</button>
                                <button id="saveNoteBtn" class="px-3 py-1 text-sm bg-black text-white hover:bg-gray-800">Save</button>
                            </div>
                        </div>
                        
                        <!-- Notes List -->
                        <div id="notesList" class="space-y-3 max-h-96 overflow-y-auto overflow-x-hidden">
                            <!-- Notes will be populated here -->
                        </div>
                        
                        <div id="noNotesMessage" class="text-gray-500 text-sm text-center py-8">
                            No notes yet. Click "Add Note" to create your first note.
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Add New Customer Modal -->
    <div id="addCustomerModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-4 sm:p-6 border-4 border-black modal-content max-w-lg w-full mx-4 sm:mx-6 max-h-96 overflow-y-auto">
            <div class="flex justify-between items-center mb-4 border-b-2 border-black pb-2">
                <h3 class="text-lg font-semibold text-black">Add New Client</h3>
                <button onclick="closeAddCustomerModal()" class="text-black text-xl hover:text-gray-600">&times;</button>
            </div>
            
            <form id="addCustomerForm" class="space-y-4">
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500 uppercase tracking-wide">Name *</label>
                        <input type="text" id="newCustomerName" required 
                               class="w-full border-b-2 border-gray-300 px-2 py-1 focus:border-black focus:outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase tracking-wide">Company</label>
                        <input type="text" id="newCustomerCompany" 
                               class="w-full border-b-2 border-gray-300 px-2 py-1 focus:border-black focus:outline-none">
                    </div>
                </div>
                
                <div>
                    <label class="text-xs text-gray-500 uppercase tracking-wide">Email</label>
                    <input type="email" id="newCustomerEmail" 
                           class="w-full border-b-2 border-gray-300 px-2 py-1 focus:border-black focus:outline-none">
                </div>
                
                <div>
                    <label class="text-xs text-gray-500 uppercase tracking-wide">Project Name</label>
                    <input type="text" id="newCustomerProject" 
                           class="w-full border-b-2 border-gray-300 px-2 py-1 focus:border-black focus:outline-none">
                </div>
                
                <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                    <div>
                        <label class="text-xs text-gray-500 uppercase tracking-wide">Domain</label>
                        <input type="url" id="newCustomerDomain" placeholder="https://example.com"
                               class="w-full border-b-2 border-gray-300 px-2 py-1 focus:border-black focus:outline-none">
                    </div>
                    <div>
                        <label class="text-xs text-gray-500 uppercase tracking-wide">Repository</label>
                        <input type="url" id="newCustomerRepo" placeholder="https://github.com/user/repo"
                               class="w-full border-b-2 border-gray-300 px-2 py-1 focus:border-black focus:outline-none">
                    </div>
                </div>
                
                <div class="flex items-center space-x-4 bg-gray-50 p-3 border border-gray-300">
                    <label class="flex items-center space-x-2">
                        <input type="checkbox" id="isPotentialCustomer" class="border border-gray-400">
                        <span class="text-sm text-gray-700">Mark as <strong>Potential Client</strong></span>
                    </label>
                    <div class="text-xs text-gray-500">
                        (You can change this later in client details)
                    </div>
                </div>
                
                <div class="flex flex-col sm:flex-row gap-3 pt-4 border-t border-gray-300">
                    <button type="submit" class="bg-black text-white px-4 py-2 flex-1 hover:bg-gray-800 transition-colors">
                        Create Client
                    </button>
                    <button type="button" onclick="closeAddCustomerModal()" class="border border-gray-400 text-black px-4 py-2 hover:bg-gray-100 transition-colors">
                        Cancel
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Authentication variables (same as admin-dashboard)
        let isAuthenticated = false;
        let currentUser = null;
        let supabaseClient = null;
        let allCustomers = [];
        let filteredCustomers = [];
        let selectedCustomers = new Set();

        // Customer data from database
        let allCustomersData = [];
        let customerNotes = {};
        let currentCustomerId = null;

        // Initialize app
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 DOM loaded, initializing customer management...');
            
            try {
                // Initialize AdminAuth
                if (window.AdminAuth) {
                    console.log('✅ AdminAuth found');
                    await window.AdminAuth.initialize();
                    
                    // Check authentication - redirect to login if not authenticated
                    if (!window.AdminAuth.requireAuth()) {
                        return; // Redirect will happen in requireAuth()
                    }
                    
                    console.log('✅ User authenticated, showing dashboard');
                    await showDashboard();
                } else {
                    console.error('❌ AdminAuth not found! Check if admin-auth.js is loaded.');
                    window.location.href = 'login.html';
                }
            } catch (error) {
                console.error('❌ Initialization error:', error);
                window.location.href = 'login.html';
            }
        });


        async function showDashboard() {
            console.log('🏠 Initializing customer dashboard...');
            isAuthenticated = true;
            
            // Initialize supabase client for local development
            try {
                const isLocalDevelopment = window.location.protocol === 'file:' || 
                                         window.location.hostname === 'localhost' || 
                                         window.location.hostname === '127.0.0.1' || 
                                         window.location.hostname === '';

                if (isLocalDevelopment) {
                    console.log('🔧 Customer management: Local development mode detected');
                    supabaseClient = window.supabase.createClient(
                        'https://ciulpbxkwcbzoshlzmvb.supabase.co',
                        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNpdWxwYnhrd2Niem9zaGx6bXZiIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTYyOTY4NTcsImV4cCI6MjA3MTg3Mjg1N30.UvoAL-i_Xv-h_OKfa8NN2CoClGBfQYHv1vNeu0elERo'
                    );
                } else {
                    if (!window.DATABASE_CONFIG || !window.DATABASE_CONFIG.enabled || 
                        window.DATABASE_CONFIG.provider !== 'supabase') {
                        throw new Error('Database not configured for production. Customer management unavailable.');
                    }
                    supabaseClient = window.supabase.createClient(
                        window.DATABASE_CONFIG.supabaseUrl,
                        window.DATABASE_CONFIG.supabaseKey
                    );
                }
            } catch (error) {
                console.error('Database initialization error:', error);
                showError('Failed to initialize database connection: ' + error.message);
                return;
            }
            
            // Initialize shared navbar
            initializeNavbar('customers', 'Customer Management');
            
            await loadCustomerData();
            setupEventListeners();
        }


        // Customer management functions
        async function loadCustomerData() {
            try {
                console.log('Loading customer data...');
                document.getElementById('loadingState').classList.remove('hidden');
                document.getElementById('errorState').classList.add('hidden');
                document.getElementById('tableContainer').classList.add('hidden');
                document.getElementById('emptyState').classList.add('hidden');

                console.log('Supabase client check:', supabaseClient);

                // Load customers from Supabase
                const { data: customers, error } = await supabaseClient
                    .from('customers')
                    .select('*')
                    .order('created_at', { ascending: false });

                console.log('Load customers response:', { data: customers, error });

                if (error) {
                    console.error('Error loading customers:', error);
                    throw error;
                }

                allCustomers = customers || [];
                filteredCustomers = [...allCustomers];

                // Load notes for all customers
                await loadAllCustomerNotes();

                updateStats();
                updateTable();

                document.getElementById('loadingState').classList.add('hidden');
                
                if (allCustomers.length === 0) {
                    document.getElementById('emptyState').classList.remove('hidden');
                } else {
                    document.getElementById('tableContainer').classList.remove('hidden');
                }

            } catch (error) {
                console.error('Error loading customers:', error);
                showError('Failed to load customer data: ' + error.message);
            }
        }

        async function loadAllCustomerNotes() {
            try {
                const { data: notes, error } = await supabaseClient
                    .from('customer_notes')
                    .select('*')
                    .order('date', { ascending: true });

                if (error) throw error;

                // Organize notes by customer ID
                customerNotes = {};
                notes?.forEach(note => {
                    if (!customerNotes[note.customer_id]) {
                        customerNotes[note.customer_id] = [];
                    }
                    customerNotes[note.customer_id].push(note);
                });
            } catch (error) {
                console.error('Error loading notes:', error);
            }
        }

        function updateStats() {
            const total = allCustomers.length;
            const active = allCustomers.filter(c => ['in-progress', 'reviewing'].includes(c.status)).length;
            const pending = allCustomers.filter(c => ['first-brief', 'contract-sent'].includes(c.status)).length;
            const totalValue = allCustomers.reduce((sum, c) => sum + (parseFloat(c.agreed_price) || 0), 0);
            const selected = selectedCustomers ? selectedCustomers.size : 0;
            
            const thisMonth = allCustomers.filter(c => {
                const date = new Date(c.created_at);
                const now = new Date();
                return date.getMonth() === now.getMonth() && date.getFullYear() === now.getFullYear();
            }).length;

            document.getElementById('totalCustomers').textContent = total;
            document.getElementById('activeProjects').textContent = active;
            document.getElementById('pendingFeedback').textContent = pending;
            document.getElementById('totalValue').textContent = '$' + formatPrice(totalValue);
            document.getElementById('selectedCountStat').textContent = selected;
            document.getElementById('thisMonthCustomers').textContent = thisMonth;
        }

        function updateTable() {
            const tbody = document.getElementById('customersTableBody');
            tbody.innerHTML = '';

            filteredCustomers.forEach(customer => {
                const row = createCustomerRow(customer);
                tbody.appendChild(row);
            });
        }

        function createCustomerRow(customer) {
            const row = document.createElement('tr');
            const isPotential = customer.is_potential;
            
            // Apply different styling for potential clients
            const rowClass = isPotential 
                ? 'table-row cursor-pointer border-b border-gray-200 bg-blue-50 hover:bg-blue-100' 
                : 'table-row cursor-pointer border-b border-gray-200';
            
            row.className = rowClass;
            row.dataset.customerId = customer.id;

            const date = new Date(customer.created_at).toLocaleDateString();
            const statusClass = getStatusColor(customer.status).split(' ')[0]; // Get text color class
            
            const nameDisplay = isPotential 
                ? `${customer.name} <span class="inline-block px-2 py-1 text-xs bg-blue-200 text-blue-800 rounded ml-2">POTENTIAL</span>`
                : customer.name;
            
            // Hide status for potential clients
            const statusDisplay = isPotential 
                ? '<span class="text-gray-400 text-xs italic">No status</span>'
                : `<span class="${statusClass}">${formatStatus(customer.status)}</span>`;
            
            // Hide price for potential clients
            const priceDisplay = isPotential 
                ? '<span class="text-gray-400 text-xs italic">No price</span>'
                : `$${formatPrice(customer.agreed_price || 0)}`;
            
            row.innerHTML = `
                <td class="px-4 py-3 text-sm text-black">
                    <input type="checkbox" class="customer-checkbox focus:outline-none" data-customer-id="${customer.id}" onchange="updateBulkActions()">
                </td>
                <td class="px-4 py-3 text-sm text-black">${nameDisplay}</td>
                <td class="px-4 py-3 text-sm text-black">${customer.company || 'N/A'}</td>
                <td class="px-4 py-3 text-sm text-black">${customer.project || 'N/A'}</td>
                <td class="px-4 py-3 text-sm ${isPotential ? 'text-gray-400' : 'text-black font-medium'}">${priceDisplay}</td>
                <td class="px-4 py-3 text-sm">${statusDisplay}</td>
                <td class="px-4 py-3 text-sm text-black">${date}</td>
            `;

            // Add click handler but prevent it when clicking checkbox
            row.addEventListener('click', (e) => {
                if (!e.target.classList.contains('customer-checkbox')) {
                    showCustomerDetails(customer);
                }
            });

            return row;
        }

        function setupEventListeners() {
            console.log('Setting up event listeners...');
            document.getElementById('refreshBtn').addEventListener('click', loadCustomerData);
            document.getElementById('logoutBtn').addEventListener('click', () => window.AdminAuth.logout());
            document.getElementById('addNewCustomerBtn').addEventListener('click', showAddCustomerModal);
            document.getElementById('retryBtn').addEventListener('click', loadCustomerData);

            // Customer details modal
            document.getElementById('closeDetailsModal').addEventListener('click', closeCustomerDetailsModal);
            
            // Notes functionality
            document.getElementById('addNoteBtn').addEventListener('click', showAddNoteForm);
            document.getElementById('cancelNoteBtn').addEventListener('click', hideAddNoteForm);
            document.getElementById('saveNoteBtn').addEventListener('click', saveNote);
            
            // Add customer form - prevent default submission
            console.log('Setting up add customer form listener...');
            const addCustomerForm = document.getElementById('addCustomerForm');
            console.log('Add customer form element:', addCustomerForm);
            
            if (addCustomerForm) {
                addCustomerForm.addEventListener('submit', function(e) {
                    console.log('Form submit event triggered!');
                    e.preventDefault();
                    e.stopPropagation();
                    handleAddCustomerClick();
                    return false;
                });
                console.log('Form listener attached successfully');
            } else {
                console.error('Add customer form not found!');
            }
            
            // Bulk actions
            document.getElementById('applyBulkStatus').addEventListener('click', applyBulkStatusChange);
            document.getElementById('bulkArchive').addEventListener('click', bulkArchiveCustomers);
            document.getElementById('clearSelection').addEventListener('click', clearAllSelections);

            // Filter listeners
            document.getElementById('statusFilter').addEventListener('change', applyFilters);
            document.getElementById('typeFilter').addEventListener('change', applyFilters);
            document.getElementById('searchCustomer').addEventListener('input', applyFilters);

            // Modal outside click
            document.getElementById('addCustomerModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeAddCustomerModal();
                }
            });
            
            document.getElementById('customerDetailsModal').addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCustomerDetailsModal();
                }
            });
        }


        function showAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.remove('hidden');
            document.getElementById('newCustomerName').focus();
        }

        function closeAddCustomerModal() {
            document.getElementById('addCustomerModal').classList.add('hidden');
            document.getElementById('addCustomerForm').reset();
        }

        async function handleAddCustomerClick() {
            console.log('=== Add customer function called ===');
            
            try {
                const formData = {
                    name: document.getElementById('newCustomerName').value.trim(),
                    company: document.getElementById('newCustomerCompany').value.trim() || null,
                    email: document.getElementById('newCustomerEmail').value.trim() || null,
                    project: document.getElementById('newCustomerProject').value.trim() || null,
                    domain: document.getElementById('newCustomerDomain').value.trim() || null,
                    repo: document.getElementById('newCustomerRepo').value.trim() || null,
                    is_potential: document.getElementById('isPotentialCustomer').checked,
                    status: 'first-brief',
                    agreed_price: 0
                };

                if (!formData.name) {
                    alert('Customer name is required');
                    return;
                }

                console.log('Form data:', formData);
                console.log('Supabase client:', supabaseClient);

                // Insert into database
                const { data: newCustomer, error } = await supabaseClient
                    .from('customers')
                    .insert(formData)
                    .select()
                    .single();

                console.log('Database response:', { data: newCustomer, error });

                if (error) {
                    console.error('Database error:', error);
                    throw error;
                }

                // Add to local arrays
                allCustomers.unshift(newCustomer);
                filteredCustomers = [...allCustomers];

                // Add welcome note
                await addCustomerNote(newCustomer.id, 'Customer added to system', true);

                // Update UI
                updateStats();
                updateTable();
                closeAddCustomerModal();

                alert('Customer added successfully!');

            } catch (error) {
                console.error('Error adding customer:', error);
                alert('Failed to add customer: ' + error.message);
            }
        }

        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            const searchTerm = document.getElementById('searchCustomer').value.toLowerCase();

            filteredCustomers = allCustomers.filter(customer => {
                if (statusFilter) {
                    if (statusFilter === 'potential') {
                        if (!customer.is_potential) {
                            return false;
                        }
                    } else if (customer.status !== statusFilter) {
                        return false;
                    }
                }

                if (typeFilter) {
                    if (typeFilter === 'potential' && !customer.is_potential) {
                        return false;
                    }
                    if (typeFilter === 'confirmed' && customer.is_potential) {
                        return false;
                    }
                }

                if (searchTerm) {
                    const searchableText = `${customer.name} ${customer.company || ''} ${customer.email || ''} ${customer.project || ''}`.toLowerCase();
                    if (!searchableText.includes(searchTerm)) {
                        return false;
                    }
                }

                return true;
            });

            updateTable();
        }

        function showError(message) {
            document.getElementById('loadingState').classList.add('hidden');
            document.getElementById('tableContainer').classList.add('hidden');
            document.getElementById('emptyState').classList.add('hidden');
            document.getElementById('errorState').classList.remove('hidden');
            document.getElementById('errorMessage').textContent = message;
        }

        // Customer Details Modal Functions
        function showCustomerDetails(customer) {
            currentCustomerId = customer.id;
            const modal = document.getElementById('customerDetailsModal');
            const content = document.getElementById('customerDetailsContent');
            
            const date = new Date(customer.created_at).toLocaleDateString();
            const statusClass = getStatusColor(customer.status).split(' ')[0];
            
            content.innerHTML = `
                <div class="space-y-6">
                    <!-- Customer Information -->
                    <div class="bg-gray-50 p-4 border border-gray-200">
                        <h4 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide border-b border-gray-300 pb-1">Customer Information</h4>
                        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
                            <div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Name</div>
                                <input type="text" id="customerNameEdit" value="${customer.name}" 
                                       class="text-black font-medium text-lg bg-transparent border-b border-gray-300 focus:border-black focus:outline-none w-full" 
                                       onchange="updateCustomerField(${customer.id}, 'name', this.value)">
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Company</div>
                                <input type="text" id="customerCompanyEdit" value="${customer.company || ''}" placeholder="Company name"
                                       class="text-black font-light bg-transparent border-b border-gray-300 focus:border-black focus:outline-none w-full" 
                                       onchange="updateCustomerField(${customer.id}, 'company', this.value)">
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Email</div>
                                <input type="email" id="customerEmailEdit" value="${customer.email || ''}" placeholder="email@company.com"
                                       class="text-black font-light bg-transparent border-b border-gray-300 focus:border-black focus:outline-none w-full" 
                                       onchange="updateCustomerField(${customer.id}, 'email', this.value)">
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Created</div>
                                <div class="text-black font-light">${date}</div>
                            </div>
                            <div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide mb-2">Client Type</div>
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="potentialToggle" ${customer.is_potential ? 'checked' : ''} 
                                           class="border border-gray-400" onchange="togglePotentialStatus(${customer.id}, this.checked)">
                                    <span class="text-sm ${customer.is_potential ? 'text-blue-600 font-medium' : 'text-gray-600'}">
                                        ${customer.is_potential ? 'Potential Client' : 'Confirmed Client'}
                                    </span>
                                </label>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Project & Financial Details -->
                    <div class="bg-white p-4 border-2 border-black">
                        <h4 class="text-sm font-semibold text-black mb-4 uppercase tracking-wide border-b-2 border-black pb-2">Project Details</h4>
                        <div class="space-y-4">
                            <div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Project Name</div>
                                <input type="text" id="customerProjectEdit" value="${customer.project}" 
                                       class="text-black font-medium text-lg bg-transparent border-b-2 border-gray-400 focus:border-black focus:outline-none w-full" 
                                       onchange="updateCustomerField(${customer.id}, 'project', this.value)">
                            </div>
                            
                            ${!customer.is_potential ? `
                            <div class="bg-yellow-50 p-3 border-l-4 border-yellow-400">
                                <div class="text-xs text-gray-600 uppercase tracking-wide mb-2">Agreed Price</div>
                                <div class="flex items-center space-x-3">
                                    <input type="number" id="priceInput" value="${customer.agreed_price || 0}" min="0" step="50" 
                                           class="border-2 border-gray-400 px-3 py-2 bg-white focus:outline-none focus:border-black text-sm w-32 font-medium" 
                                           onchange="changeCustomerPrice(${customer.id}, this.value)">
                                    <span class="text-black font-bold text-2xl">$${formatPrice(customer.agreed_price || 0)}</span>
                                    <span class="text-xs text-gray-500">USD</span>
                                </div>
                            </div>
                            ` : `
                            <div class="bg-blue-50 p-3 border border-blue-200 rounded">
                                <div class="text-xs text-blue-600 uppercase tracking-wide mb-1 font-medium">Agreed Price</div>
                                <div class="text-sm text-blue-700 italic">No pricing - This is a potential client</div>
                                <div class="text-xs text-blue-500 mt-1">Change to "Confirmed Client" above to set pricing</div>
                            </div>
                            `}
                            
                            ${!customer.is_potential ? `
                            <div>
                                <div class="text-xs text-gray-500 uppercase tracking-wide mb-2">Project Status</div>
                                <div class="flex items-center space-x-3">
                                    <select id="statusSelect" class="border-2 border-gray-400 px-3 py-2 bg-white focus:outline-none focus:border-black text-sm" onchange="changeCustomerStatus(${customer.id}, this.value)">
                                        <option value="first-brief" ${customer.status === 'first-brief' ? 'selected' : ''}>First Brief</option>
                                        <option value="contract-sent" ${customer.status === 'contract-sent' ? 'selected' : ''}>Contract Sent</option>
                                        <option value="contract-agreed" ${customer.status === 'contract-agreed' ? 'selected' : ''}>Contract Agreed</option>
                                        <option value="in-progress" ${customer.status === 'in-progress' ? 'selected' : ''}>In Progress</option>
                                        <option value="reviewing" ${customer.status === 'reviewing' ? 'selected' : ''}>Reviewing</option>
                                        <option value="waiting-payment" ${customer.status === 'waiting-payment' ? 'selected' : ''}>Waiting for Payment</option>
                                        <option value="finished" ${customer.status === 'finished' ? 'selected' : ''}>Finished</option>
                                    </select>
                                    <span id="statusBadge" class="px-3 py-2 text-sm font-medium border-2 ${getStatusColor(customer.status)}">${formatStatus(customer.status)}</span>
                                </div>
                            </div>
                            ` : `
                            <div class="bg-blue-50 p-3 border border-blue-200 rounded">
                                <div class="text-xs text-blue-600 uppercase tracking-wide mb-1 font-medium">Project Status</div>
                                <div class="text-sm text-blue-700 italic">No status - This is a potential client</div>
                                <div class="text-xs text-blue-500 mt-1">Change to "Confirmed Client" above to set project status</div>
                            </div>
                            `}
                        </div>
                    </div>
                    
                    <!-- Project Links - Status Line -->
                    <div class="bg-gray-50 px-4 py-3 border border-gray-200 space-y-2">
                        <div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Repository</div>
                            <div class="flex items-center space-x-1">
                                <span class="text-gray-600 font-medium">📁</span>
                                <input type="url" id="customerRepoEdit" value="${customer.repo || ''}" placeholder="github.com/user/repo"
                                       class="text-black font-mono text-xs bg-transparent border-b border-gray-300 focus:border-black focus:outline-none w-48" 
                                       onchange="updateCustomerField(${customer.id}, 'repo', this.value)">
                                <button onclick="copyToClipboard(document.getElementById('customerRepoEdit').value)" class="text-gray-600 hover:text-black transition-colors" title="Copy repository">📋</button>
                            </div>
                        </div>
                        <div>
                            <div class="text-xs text-gray-500 uppercase tracking-wide mb-1">Domain</div>
                            <div class="flex items-center space-x-1">
                                <span class="text-gray-600 font-medium">🌐</span>
                                <input type="url" id="customerDomainEdit" value="${customer.domain || ''}" placeholder="domain.com"
                                       class="text-black font-mono text-xs bg-transparent border-b border-gray-300 focus:border-black focus:outline-none w-40" 
                                       onchange="updateCustomerField(${customer.id}, 'domain', this.value)">
                                <button onclick="copyToClipboard(document.getElementById('customerDomainEdit').value)" class="text-gray-600 hover:text-black transition-colors" title="Copy domain">📋</button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            loadCustomerNotes(customer.id);
            modal.classList.remove('hidden');
        }
        
        function closeCustomerDetailsModal() {
            document.getElementById('customerDetailsModal').classList.add('hidden');
            hideAddNoteForm();
            currentCustomerId = null;
        }

        // Duplicate function removed - using the updated version above

        // Notes Management Functions
        function convertTextToLinksHTML(text) {
            // URL regex pattern to match http://, https://, and www. URLs
            const urlRegex = /(https?:\/\/[^\s]+)|(www\.[^\s]+)|((?:[a-zA-Z0-9-]+\.)+[a-zA-Z]{2,}(?:\/[^\s]*)?)/g;
            
            return text.replace(urlRegex, function(url) {
                // Add protocol if missing
                let href = url;
                if (!url.match(/^https?:\/\//)) {
                    href = 'https://' + url;
                }
                
                // Create clickable link with word-break styling
                return `<a href="${href}" target="_blank" rel="noopener noreferrer" 
                           class="text-blue-600 hover:text-blue-800 underline break-all word-break-all hyphens-auto inline-block max-w-full" 
                           title="${href}">${url}</a>`;
            });
        }
        
        async function addCustomerNote(customerId, text, isStatusChange = false) {
            try {
                const { data: note, error } = await supabaseClient
                    .from('customer_notes')
                    .insert({
                        customer_id: customerId,
                        text: text,
                        is_status_change: isStatusChange
                    })
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Add to local notes
                if (!customerNotes[customerId]) {
                    customerNotes[customerId] = [];
                }
                customerNotes[customerId].push(note);
                
                // Refresh notes display if modal is open
                if (currentCustomerId === customerId) {
                    loadCustomerNotes(customerId);
                }
                
                return note;
            } catch (error) {
                console.error('Error adding note:', error);
                throw error;
            }
        }
        
        function loadCustomerNotes(customerId) {
            const notes = customerNotes[customerId] || [];
            const notesList = document.getElementById('notesList');
            const noNotesMessage = document.getElementById('noNotesMessage');
            
            if (notes.length === 0) {
                notesList.classList.add('hidden');
                noNotesMessage.classList.remove('hidden');
                return;
            }
            
            notesList.classList.remove('hidden');
            noNotesMessage.classList.add('hidden');
            
            // Group notes by date
            const notesByDate = {};
            notes.forEach(note => {
                const dateKey = new Date(note.date).toDateString();
                if (!notesByDate[dateKey]) {
                    notesByDate[dateKey] = [];
                }
                notesByDate[dateKey].push(note);
            });
            
            // Sort dates (newest first)
            const sortedDates = Object.keys(notesByDate).sort((a, b) => new Date(b) - new Date(a));
            
            notesList.innerHTML = sortedDates.map(dateKey => {
                const dayNotes = notesByDate[dateKey];
                const formattedDate = new Date(dateKey).toLocaleDateString('en-US', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                return `
                    <div class="border-b border-gray-200 pb-3 mb-3 last:border-b-0">
                        <div class="text-xs font-medium text-gray-500 mb-2 uppercase tracking-wide">${formattedDate}</div>
                        <div class="space-y-2">
                            ${dayNotes.sort((a, b) => new Date(b.date) - new Date(a.date)).map(note => {
                                const time = new Date(note.date).toLocaleTimeString('en-US', { 
                                    hour: '2-digit', 
                                    minute: '2-digit' 
                                });
                                const isStatusChange = note.is_status_change || note.isStatusChange; // Handle both formats
                                const noteClass = isStatusChange ? 'bg-blue-50 border-blue-200' : 'bg-gray-50 border-gray-200';
                                const textClass = isStatusChange ? 'text-blue-800' : 'text-black';
                                return `
                                    <div class="${noteClass} p-3 border relative group">
                                        ${!isStatusChange ? `
                                            <button onclick="deleteNote(${note.id}, ${customerId})" 
                                                    class="absolute top-2 right-2 text-red-500 hover:text-red-700 opacity-0 group-hover:opacity-100 transition-opacity text-xs"
                                                    title="Delete note">
                                                ✕
                                            </button>
                                        ` : ''}
                                        <div class="text-sm ${textClass} break-words ${!isStatusChange ? 'pr-6' : ''}">${convertTextToLinksHTML(note.text)}</div>
                                        <div class="text-xs text-gray-400 mt-1">
                                            ${time}
                                            ${isStatusChange ? '<span class="ml-2 text-blue-500">• System</span>' : ''}
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function showAddNoteForm() {
            document.getElementById('addNoteForm').classList.remove('hidden');
            document.getElementById('noteText').focus();
        }
        
        function hideAddNoteForm() {
            document.getElementById('addNoteForm').classList.add('hidden');
            document.getElementById('noteText').value = '';
        }
        
        async function saveNote() {
            try {
                const noteText = document.getElementById('noteText').value.trim();
                
                if (!noteText) {
                    alert('Please enter a note');
                    return;
                }
                
                if (!currentCustomerId) {
                    alert('No customer selected');
                    return;
                }
                
                // Save note to database
                await addCustomerNote(currentCustomerId, noteText, false);
                
                // Hide form
                hideAddNoteForm();
                
                console.log('Note saved successfully');
                
            } catch (error) {
                console.error('Error saving note:', error);
                alert('Failed to save note: ' + error.message);
            }
        }
        
        async function deleteNote(noteId, customerId) {
            try {
                // Show confirmation dialog
                if (!confirm('Are you sure you want to delete this note? This action cannot be undone.')) {
                    return;
                }
                
                // Delete from database
                const { error } = await supabaseClient
                    .from('customer_notes')
                    .delete()
                    .eq('id', noteId);
                
                if (error) throw error;
                
                // Remove from local notes
                if (customerNotes[customerId]) {
                    customerNotes[customerId] = customerNotes[customerId].filter(note => note.id !== noteId);
                }
                
                // Refresh notes display
                loadCustomerNotes(customerId);
                
                console.log('Note deleted successfully');
                
            } catch (error) {
                console.error('Error deleting note:', error);
                alert('Failed to delete note: ' + error.message);
            }
        }
        
        // Status Management Functions
        function getStatusColor(status) {
            const statusColors = {
                'first-brief': 'text-gray-600 border-gray-400 bg-gray-50',
                'contract-sent': 'text-orange-600 border-orange-400 bg-orange-50',
                'contract-agreed': 'text-blue-600 border-blue-400 bg-blue-50',
                'in-progress': 'text-green-600 border-green-400 bg-green-50',
                'reviewing': 'text-purple-600 border-purple-400 bg-purple-50',
                'waiting-payment': 'text-yellow-600 border-yellow-400 bg-yellow-50',
                'finished': 'text-gray-800 border-gray-600 bg-gray-100'
            };
            return statusColors[status] || 'text-gray-600 border-gray-400 bg-gray-50';
        }
        
        function formatStatus(status) {
            const statusLabels = {
                'first-brief': 'First Brief',
                'contract-sent': 'Contract Sent',
                'contract-agreed': 'Contract Agreed',
                'in-progress': 'In Progress',
                'reviewing': 'Reviewing',
                'waiting-payment': 'Waiting for Payment',
                'finished': 'Finished'
            };
            return statusLabels[status] || status;
        }
        
        async function changeCustomerStatus(customerId, newStatus) {
            try {
                // Find customer in local array
                const customerIndex = allCustomers.findIndex(c => c.id === customerId);
                if (customerIndex === -1) return;
                
                const oldStatus = allCustomers[customerIndex].status;
                if (oldStatus === newStatus) return;
                
                // Update in database
                const { error } = await supabaseClient
                    .from('customers')
                    .update({ status: newStatus })
                    .eq('id', customerId);
                
                if (error) throw error;
                
                // Update local data
                allCustomers[customerIndex].status = newStatus;
                filteredCustomers = [...allCustomers];
                
                // Update the badge
                const statusBadge = document.getElementById('statusBadge');
                if (statusBadge) {
                    statusBadge.textContent = formatStatus(newStatus);
                    statusBadge.className = `px-3 py-2 text-sm font-medium border-2 ${getStatusColor(newStatus)}`;
                }
                
                // Add status change note to database
                const noteText = `Status changed from "${formatStatus(oldStatus)}" to "${formatStatus(newStatus)}"`;
                await addCustomerNote(customerId, noteText, true);
                
                // Refresh table and stats
                updateStats();
                updateTable();
                
                console.log(`Status changed for customer ${customerId}: ${oldStatus} -> ${newStatus}`);
                
            } catch (error) {
                console.error('Error changing customer status:', error);
                alert('Failed to update status: ' + error.message);
            }
        }
        
        function formatPrice(price) {
            const numPrice = parseFloat(price) || 0;
            if (isNaN(numPrice)) return '0';
            return new Intl.NumberFormat('en-US', {
                minimumFractionDigits: 0,
                maximumFractionDigits: 0
            }).format(numPrice);
        }
        
        async function changeCustomerPrice(customerId, newPrice) {
            try {
                const price = parseFloat(newPrice) || 0;
                
                // Find customer in local array
                const customerIndex = allCustomers.findIndex(c => c.id === customerId);
                if (customerIndex === -1) return;
                
                const oldPrice = allCustomers[customerIndex].agreed_price || 0;
                if (oldPrice === price) return;
                
                // Update in database
                const { error } = await supabaseClient
                    .from('customers')
                    .update({ agreed_price: price })
                    .eq('id', customerId);
                
                if (error) throw error;
                
                // Update local data
                allCustomers[customerIndex].agreed_price = price;
                filteredCustomers = [...allCustomers];
                
                // Update the display
                const priceDisplay = document.querySelector('#priceInput').nextElementSibling;
                if (priceDisplay) {
                    priceDisplay.textContent = `$${formatPrice(price)}`;
                }
                
                // Add price change note to database
                const noteText = `Price updated from $${formatPrice(oldPrice)} to $${formatPrice(price)}`;
                await addCustomerNote(customerId, noteText, true);
                
                // Refresh table and stats
                updateStats();
                updateTable();
                
                console.log(`Price changed for customer ${customerId}: $${oldPrice} -> $${price}`);
                
            } catch (error) {
                console.error('Error changing customer price:', error);
                alert('Failed to update price: ' + error.message);
            }
        }
        
        // Customer Field Update Functions
        async function togglePotentialStatus(customerId, isPotential) {
            try {
                // Update in database
                const { error } = await supabaseClient
                    .from('customers')
                    .update({ is_potential: isPotential })
                    .eq('id', customerId);
                
                if (error) throw error;
                
                // Update local data
                const customerIndex = allCustomers.findIndex(c => c.id === customerId);
                if (customerIndex !== -1) {
                    allCustomers[customerIndex].is_potential = isPotential;
                    filteredCustomers = [...allCustomers];
                }
                
                // Update the label in the modal
                const statusLabel = document.querySelector('#potentialToggle').nextElementSibling;
                if (statusLabel) {
                    statusLabel.textContent = isPotential ? 'Potential Client' : 'Confirmed Client';
                    statusLabel.className = isPotential ? 'text-sm text-blue-600 font-medium' : 'text-sm text-gray-600';
                }
                
                // Add status change note
                const statusText = isPotential ? 'Potential Client' : 'Confirmed Client';
                const noteText = `Client type changed to "${statusText}"`;
                await addCustomerNote(customerId, noteText, true);
                
                // Update table and stats
                updateStats();
                updateTable();
                
                console.log(`Client type changed for customer ${customerId}: ${isPotential ? 'Potential' : 'Confirmed'}`);
                
            } catch (error) {
                console.error('Error toggling potential status:', error);
                alert('Failed to update client type: ' + error.message);
                // Revert checkbox state
                document.getElementById('potentialToggle').checked = !isPotential;
            }
        }
        
        async function updateCustomerField(customerId, fieldName, newValue) {
            try {
                // Find customer in local array
                const customerIndex = allCustomers.findIndex(c => c.id === customerId);
                if (customerIndex === -1) return;
                
                const oldValue = allCustomers[customerIndex][fieldName];
                if (oldValue === newValue) return;
                
                // Update in database
                const { error } = await supabaseClient
                    .from('customers')
                    .update({ [fieldName]: newValue })
                    .eq('id', customerId);
                
                if (error) throw error;
                
                // Update local data
                allCustomers[customerIndex][fieldName] = newValue;
                filteredCustomers = [...allCustomers];
                
                // Add field change note to database
                const fieldLabels = {
                    'name': 'Customer Name',
                    'company': 'Company',
                    'email': 'Email',
                    'project': 'Project Name',
                    'domain': 'Domain URL',
                    'repo': 'Repository URL'
                };
                
                const noteText = `${fieldLabels[fieldName]} updated from "${oldValue || 'N/A'}" to "${newValue}"`;
                await addCustomerNote(customerId, noteText, true);
                
                // Update table and stats
                updateStats();
                updateTable();
                
                console.log(`${fieldLabels[fieldName]} changed for customer ${customerId}: "${oldValue}" -> "${newValue}"`);
                
            } catch (error) {
                console.error('Error updating customer field:', error);
                alert('Failed to update customer: ' + error.message);
            }
        }
        
        
        // Copy to clipboard function
        function copyToClipboard(text) {
            if (!text) {
                alert('No URL to copy');
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                // Brief visual feedback
                const event = window.event || {};
                const button = event.target;
                if (button) {
                    const originalText = button.textContent;
                    button.textContent = 'COPIED!';
                    button.classList.add('bg-green-600');
                    setTimeout(() => {
                        button.textContent = originalText;
                        button.classList.remove('bg-green-600');
                    }, 1000);
                }
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('URL copied to clipboard');
            });
        }
        
        
        // Bulk Actions Functions (selectedCustomers already declared above)
        
        function toggleSelectAll(checked) {
            const checkboxes = document.querySelectorAll('.customer-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = checked;
                const customerId = parseInt(checkbox.dataset.customerId);
                if (checked) {
                    selectedCustomers.add(customerId);
                } else {
                    selectedCustomers.delete(customerId);
                }
            });
            updateBulkActions();
        }
        
        function updateBulkActions() {
            const checkboxes = document.querySelectorAll('.customer-checkbox');
            selectedCustomers.clear();
            
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    selectedCustomers.add(parseInt(checkbox.dataset.customerId));
                }
            });
            
            const selectedCount = selectedCustomers.size;
            const bulkActionsBar = document.getElementById('bulkActionsBar');
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (selectedCount > 0) {
                bulkActionsBar.classList.remove('hidden');
                bulkActionsBar.querySelector('#selectedCount').textContent = selectedCount;
            } else {
                bulkActionsBar.classList.add('hidden');
            }
            
            // Update stats to show selected count
            updateStats();
            
            // Update select all checkbox state
            const totalCheckboxes = checkboxes.length;
            if (selectedCount === 0) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = false;
            } else if (selectedCount === totalCheckboxes) {
                selectAllCheckbox.indeterminate = false;
                selectAllCheckbox.checked = true;
            } else {
                selectAllCheckbox.indeterminate = true;
                selectAllCheckbox.checked = false;
            }
        }
        
        function applyBulkStatusChange() {
            const newStatus = document.getElementById('bulkStatusChange').value;
            if (!newStatus) {
                alert('Please select a status');
                return;
            }
            
            if (selectedCustomers.size === 0) {
                alert('Please select customers');
                return;
            }
            
            const selectedArray = Array.from(selectedCustomers);
            const customerNames = selectedArray.map(id => {
                const customer = mockCustomers.find(c => c.id === id);
                return customer ? customer.name : 'Unknown';
            });
            
            if (confirm(`Change status to "${formatStatus(newStatus)}" for ${selectedArray.length} customers?\n\n${customerNames.join(', ')}`)) {
                selectedArray.forEach(customerId => {
                    changeCustomerStatus(customerId, newStatus);
                });
                
                // Clear selections
                clearAllSelections();
                document.getElementById('bulkStatusChange').value = '';
                
                alert(`Status updated for ${selectedArray.length} customers`);
            }
        }
        
        function bulkArchiveCustomers() {
            if (selectedCustomers.size === 0) {
                alert('Please select customers to archive');
                return;
            }
            
            const selectedArray = Array.from(selectedCustomers);
            const customerNames = selectedArray.map(id => {
                const customer = mockCustomers.find(c => c.id === id);
                return customer ? customer.name : 'Unknown';
            });
            
            if (confirm(`Archive ${selectedArray.length} customers? This will remove them from the active list.\n\n${customerNames.join(', ')}`)) {
                // Remove customers from mockCustomers array
                selectedArray.forEach(customerId => {
                    const index = mockCustomers.findIndex(c => c.id === customerId);
                    if (index > -1) {
                        mockCustomers.splice(index, 1);
                    }
                });
                
                // Refresh data and clear selections
                allCustomers = [...mockCustomers];
                filteredCustomers = [...allCustomers];
                updateStats();
                updateTable();
                clearAllSelections();
                
                alert(`${selectedArray.length} customers archived`);
            }
        }
        
        function clearAllSelections() {
            selectedCustomers.clear();
            const checkboxes = document.querySelectorAll('.customer-checkbox');
            checkboxes.forEach(checkbox => checkbox.checked = false);
            document.getElementById('selectAll').checked = false;
            document.getElementById('selectAll').indeterminate = false;
            document.getElementById('bulkActionsBar').classList.add('hidden');
        }
    </script>
</body>
</html>